name: Test fastddsgen Output

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test-fastddsgen:
    name: Test fastddsgen on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-13]
        python-version: ['3.10']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          wget \
          libasio-dev \
          libtinyxml2-dev \
          libssl-dev
    
    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja asio tinyxml2 openssl@3
    
    - name: Create virtual environment
      run: |
        python -m venv build_venv
        source build_venv/bin/activate
        python -m pip install --upgrade pip wheel setuptools
    
    - name: Install FastDDS v3 (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        source build_venv/bin/activate
        bash scripts/install_fastdds_v3_colcon.sh
    
    - name: Install FastDDS v3 (macOS)
      if: runner.os == 'macOS'
      run: |
        source build_venv/bin/activate
        sudo mkdir -p /opt/fast-dds-v3
        sudo chown -R $(whoami) /opt
        bash scripts/mac/mac_install_fastdds_v3_colcon.sh
    
    - name: Test fastddsgen with single IDL file
      run: |
        source build_venv/bin/activate
        export PATH="/opt/fast-dds-gen-v3/bin:$PATH"
        export FASTDDSGEN_BIN="/opt/fast-dds-gen-v3/bin/fastddsgen"
        
        echo "=========================================="
        echo "ENVIRONMENT INFORMATION"
        echo "=========================================="
        echo "OS: $(uname -s)"
        echo "Python: $(python --version)"
        echo "fastddsgen path: $(which fastddsgen)"
        echo "fastddsgen version: $(fastddsgen -version 2>&1 | head -1)"
        echo "Java version:"
        java -version 2>&1 || echo "Java not found"
        echo ""
        
        echo "=========================================="
        echo "TEST: Generating from a single IDL file"
        echo "=========================================="
        TEST_IDL="third_party/ros-data-types-for-fastdds/src/builtin_interfaces/msg/Time.idl"
        TEST_OUT="$PWD/._test_fastddsgen_output"
        rm -rf "${TEST_OUT}"
        mkdir -p "${TEST_OUT}"
        
        echo "Input IDL: ${TEST_IDL}"
        echo "Input IDL absolute path: $(cd $(dirname ${TEST_IDL}) && pwd)/$(basename ${TEST_IDL})"
        echo "Output dir: ${TEST_OUT}"
        echo ""
        
        echo "Running fastddsgen with full output..."
        set -x
        "${FASTDDSGEN_BIN}" -python -cs -typeros2 -language c++ \
          -d "${TEST_OUT}" \
          -I "third_party/ros-data-types-for-fastdds/src" \
          -replace "${TEST_IDL}" 2>&1 | tee "${TEST_OUT}/fastddsgen.log"
        RC=$?
        set +x
        
        echo ""
        echo "=========================================="
        echo "RESULTS"
        echo "=========================================="
        echo "Exit code: ${RC}"
        echo ""
        echo "Generated directory structure:"
        find "${TEST_OUT}" -type d | sort
        echo ""
        echo "All generated files (sorted):"
        find "${TEST_OUT}" -type f | sort
        echo ""
        echo "Looking for Time.i file:"
        if [ -f "${TEST_OUT}/Time.i" ]; then
          echo "✓ Time.i found in top level"
          ls -lh "${TEST_OUT}/Time.i"
        else
          echo "✗ Time.i NOT in top level"
          echo "Searching recursively for Time.i:"
          find "${TEST_OUT}" -name "Time.i" -ls
        fi
        echo ""
        echo "All .i files:"
        find "${TEST_OUT}" -name "*.i" -ls
        echo ""
        echo "All TypeObjectSupport files:"
        find "${TEST_OUT}" -name "*TypeObjectSupport*" -ls
        echo "=========================================="
